<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="health.model.HealthDate">
	<select id="GetMyHealthDateList" resultType="health.model.HealthDateBean">
		SELECT	hd.hnum
			   ,hd.id
			   ,hd.hdate
			   ,hd.tid
			   ,h.playtime
			   ,m.name AS tname
			   ,t.activity AS tactivity
		FROM	HEALTHDATE hd
		INNER JOIN	(
		            	SELECT	hnum
		            		   ,SUM(playtime) AS playtime
		            	FROM	(
		            				SELECT	hnum
		            					   ,ROUND((endtime - starttime) * 24 * 60) AS playtime
		                  			FROM	HEALTH
		                  		)
		            	GROUP BY hnum
					) h
		ON hd.hnum = h.hnum
		LEFT OUTER JOIN MEMBER m
		ON hd.tid = m.id
		LEFT OUTER JOIN TRAINER t
		ON hd.tid = t.id
		WHERE	hd.id  = #{id}
		<if test = "tid != null and tid != 'all'">
			AND	hd.tid = #{tid}
		</if>
		ORDER BY hd.hdate DESC
	</select>
	
	<select id="GetHealthByHdate" resultType="health.model.HealthDateBean">
		SELECT 	* 
		FROM 	HEALTHDATE 
		WHERE 	hdate = #{hdate}
	</select>
	
	<select id="GetOneHealthDate" resultType="health.model.HealthDateBean">
		SELECT	h.*
			   ,m.name AS tname
		FROM   (
		      	 SELECT	* 
		      	 FROM 	HEALTHDATE 
		      	 WHERE	hnum = #{hnum}
		       ) h
		LEFT OUTER JOIN 
		MEMBER 	m
		ON 		h.tid = m.id 
	</select>
	
	<insert id="InsertHealthDate">
		INSERT INTO HEALTHDATE 
		VALUES(
				hseq.NEXTVAL
				,#{id}
				,#{hdate}
				,#{tid})
	</insert>
	
	<delete id="DeleteHealthDate">
		DELETE 	HEALTHDATE 
		WHERE 	hnum = #{hnum}
	</delete>
	
	<update id="UpdateHealthDate">
		UPDATE 	HEALTHDATE 
		SET 	hdate = #{hdate}
			   ,tid   = #{tid} 
		WHERE 	hnum = #{hnum}
	</update>
	
	<update id="UpdateHealthTid">
		UPDATE	HEALTHDATE 
		SET 	tid = #{tid} 
		WHERE 	hnum = #{hnum}
	</update>
	
	<select id="GetComp" resultType="String">
		SELECT 	odate 
		FROM 	ORDERS 
		WHERE 	onum = #{onum}
	</select>
	
	<select id="GetHealthByHdateTid" resultType="health.model.HealthDateBean">
		SELECT	*
		FROM	HEALTHDATE
		WHERE 	hdate = #{hdate}
		AND		tid   = #{tid}
	</select>
</mapper>