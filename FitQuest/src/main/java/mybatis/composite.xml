<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="composite.model.Composite">
	<select id = "GetTrainerCount" resultType = "int">
		select count(*) from
		((select id, gnum, activity, purpose, intro, exp, timage, avg(rating) as rating
		from trainer join review
		on id = tid
		group by id, gnum, activity, purpose, intro, exp, timage
		order by rating desc)
		natural join 
		(select distinct tid as id, hasReview from review))
		natural join
		((select id, name from trainer natural join member)
		natural join
		(select id, gnum, gaddr1 from trainer natural join gym))
		where id is not null
		<if test = "activity != 'null'">
			and activity = #{activity}
		</if>
		<if test = "addressDo != '%null%'">
			and gaddr1 like #{addressDo}
		</if>
		<if test = "addressSiGunGu != '%null%'">
			and gaddr1 like #{addressSiGunGu}
		</if>
		<if test = "purposeA != '%null%'">
			and purpose like #{purposeA}
		</if>
		<if test = "purposeB != '%null%'">
			and purpose like #{purposeB}
		</if>
		<if test = "purposeC != '%null%'">
			and purpose like #{purposeC}
		</if>
		<if test = "purposeD != '%null%'">
			and purpose like #{purposeD}
		</if>
    	</select>
	<select id = "GetTrainerList" resultType = "composite.model.TrainerListBean">
		select * from
		((select id, gnum, activity, purpose, intro, exp, timage, avg(rating) as rating
		from trainer join review
		on id = tid
		group by id, gnum, activity, purpose, intro, exp, timage
		order by rating desc)
		natural join 
		(select distinct tid as id, hasReview from review))
		natural join
		((select id, name from trainer natural join member)
		natural join
		(select id, gnum, gaddr1 from trainer natural join gym))
		where id is not null
		<if test = "activity != 'null'">
			and activity = #{activity}
		</if>
		<if test = "addressDo != '%null%'">
			and gaddr1 like #{addressDo}
		</if>
		<if test = "addressSiGunGu != '%null%'">
			and gaddr1 like #{addressSiGunGu}
		</if>
		<if test = "purposeA != '%null%'">
			and purpose like #{purposeA}
		</if>
		<if test = "purposeB != '%null%'">
			or purpose like #{purposeB}
		</if>
		<if test = "purposeC != '%null%'">
			or purpose like #{purposeC}
		</if>
		<if test = "purposeD != '%null%'">
			or purpose like #{purposeD}
		</if>
		<if test = "ordering == 'review'">
			order by hasReview desc, rating desc
		</if>
	</select>
	<select id = "GetSimilarTrainers" resultType = "composite.model.TrainerListBean">
		select * from
		((select id, gnum, activity, purpose, intro, exp, timage, avg(rating) as rating
		from trainer join review
		on id = tid
		group by id, gnum, activity, purpose, intro, exp, timage
		order by rating desc)
		natural join 
		(select distinct tid as id, hasReview from review))
		natural join
		((select id, name from trainer natural join member)
		natural join
		(select id, gnum, gaddr1 from trainer natural join gym))
		where activity = #{activity}
	</select>
</mapper>